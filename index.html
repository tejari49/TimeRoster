<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>TimeRoster - iOS Style</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:root {
    --ios-blue:#007AFF; --ios-green:#34C759; --ios-red:#FF3B30; --ios-orange:#FF9500;
    --ios-bg:#F2F2F7; --ios-card:#FFF; --ios-separator:rgba(60,60,67,0.36);
    --ios-text:#000; --ios-text-secondary:#8E8E93;
}
body { font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',sans-serif; background:var(--ios-bg); color:var(--ios-text); line-height:1.47; -webkit-font-smoothing:antialiased; }
.app { min-height:100vh; padding-bottom:65px; }
.nav-bar { position:fixed; top:0; left:0; right:0; height:44px; background:rgba(242,242,247,0.8); backdrop-filter:blur(20px); border-bottom:0.5px solid var(--ios-separator); display:flex; align-items:center; justify-content:center; z-index:1000; }
.nav-title { font-size:17px; font-weight:600; }
.content { margin-top:44px; padding:16px; }
.ios-card { background:var(--ios-card); border-radius:10px; margin-bottom:16px; box-shadow:0 0 0 0.5px rgba(0,0,0,0.04), 0 2px 4px rgba(0,0,0,0.08); }
.card-header { padding:12px 16px; border-bottom:0.5px solid var(--ios-separator); }
.card-title { font-size:17px; font-weight:600; }
.card-body { padding:16px; }
.ios-button { background:var(--ios-blue); color:white; border:none; border-radius:10px; padding:12px 20px; font-size:17px; font-weight:600; cursor:pointer; width:100%; margin-bottom:12px; }
.ios-button:active { opacity:0.6; }
.ios-button-secondary { background:var(--ios-bg); color:var(--ios-blue); }
.ios-button-danger { background:var(--ios-red); }
.stats-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:16px; }
.stat-card { background:var(--ios-card); border-radius:10px; padding:16px; box-shadow:0 0 0 0.5px rgba(0,0,0,0.04), 0 2px 4px rgba(0,0,0,0.08); }
.stat-label { font-size:11px; color:var(--ios-text-secondary); margin-bottom:8px; text-transform:uppercase; }
.stat-value { font-size:28px; font-weight:700; }
.stat-blue { color:var(--ios-blue); }
.stat-green { color:var(--ios-green); }
.stat-orange { color:var(--ios-orange); }
.stat-red { color:var(--ios-red); }
.ios-list { background:var(--ios-card); border-radius:10px; overflow:hidden; box-shadow:0 0 0 0.5px rgba(0,0,0,0.04), 0 2px 4px rgba(0,0,0,0.08); }
.ios-list-item { padding:12px 16px; border-bottom:0.5px solid var(--ios-separator); }
.ios-list-item:last-child { border-bottom:none; }
.ios-input { width:100%; padding:12px; border:none; border-radius:10px; background:var(--ios-bg); font-size:17px; font-family:inherit; margin-bottom:12px; }
.tab-bar { position:fixed; bottom:0; left:0; right:0; height:49px; background:rgba(242,242,247,0.8); backdrop-filter:blur(20px); border-top:0.5px solid var(--ios-separator); display:flex; z-index:1000; }
.tab-item { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; }
.tab-icon { font-size:24px; margin-bottom:2px; }
.tab-label { font-size:10px; color:var(--ios-text-secondary); }
.tab-item.active .tab-label { color:var(--ios-blue); }
.page { display:none; }
.page.active { display:block; }
.calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:12px; }
.calendar-day { aspect-ratio:1; display:flex; align-items:center; justify-content:center; border-radius:8px; cursor:pointer; }
.calendar-day.today { background:var(--ios-blue); color:white; font-weight:600; }
.modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:2000; align-items:flex-end; justify-content:center; }
.modal.active { display:flex; }
.modal-content { background:var(--ios-card); border-radius:14px 14px 0 0; width:100%; max-height:80vh; overflow-y:auto; }
.modal-header { padding:16px; border-bottom:0.5px solid var(--ios-separator); display:flex; justify-content:space-between; }
.modal-body { padding:16px; }
.chat-messages { height:400px; overflow-y:auto; margin-bottom:16px; padding:12px; background:var(--ios-bg); border-radius:10px; }
.chat-message { margin-bottom:12px; display:flex; }
.message-bubble { max-width:70%; padding:10px 14px; border-radius:18px; }
.chat-message.sent { justify-content:flex-end; }
.chat-message.sent .message-bubble { background:var(--ios-blue); color:white; }
.chat-message.received .message-bubble { background:var(--ios-card); color:var(--ios-text); box-shadow:0 0 0 0.5px rgba(0,0,0,0.04), 0 2px 4px rgba(0,0,0,0.08); }
.message-image { max-width:200px; border-radius:12px; margin-top:8px; cursor:pointer; }
.message-voice { display:flex; align-items:center; gap:8px; margin-top:8px; }
.voice-play-btn { background:white; color:var(--ios-blue); border:none; width:32px; height:32px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.linked-user-item { padding:8px 12px; background:var(--ios-bg); border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
.chat-input-container { display:flex; gap:8px; }
.chat-input { flex:1; padding:10px 14px; border:none; border-radius:18px; background:var(--ios-bg); }
.chat-send-btn { background:var(--ios-blue); color:white; border:none; width:36px; height:36px; border-radius:50%; cursor:pointer; }
.lock-screen { position:fixed; top:0; left:0; right:0; bottom:0; background:var(--ios-bg); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:3000; padding:20px; }
.lock-screen.active { display:flex; }
.lock-icon { font-size:60px; margin-bottom:20px; }
.todo-item { display:flex; align-items:center; padding:12px 16px; border-bottom:0.5px solid var(--ios-separator); }
.todo-checkbox { width:22px; height:22px; border:2px solid var(--ios-blue); border-radius:50%; margin-right:12px; cursor:pointer; }
.todo-checkbox.checked { background:var(--ios-blue); }
.time-display { text-align:center; padding:40px 20px; }
.current-time { font-size:48px; font-weight:700; color:var(--ios-blue); margin-bottom:20px; }
@media (max-width:767px) {
    .desktop-only { display:none; }
}
@media (min-width:768px) {
    .app { display:flex; max-width:1200px; margin:0 auto; padding-bottom:0; }
    .sidebar-desktop { width:280px; background:var(--ios-card); border-right:0.5px solid var(--ios-separator); position:sticky; top:0; height:100vh; }
    .sidebar-item { padding:12px 20px; cursor:pointer; display:flex; align-items:center; }
    .sidebar-item.active { background:rgba(0,122,255,0.1); color:var(--ios-blue); }
    .nav-bar, .tab-bar { display:none; }
    .content { flex:1; margin-top:0; padding:32px; }
    .stats-grid { grid-template-columns:repeat(4,1fr); }
    .mobile-only { display:none; }
    .desktop-only { display:block; }
}
</style>
</head>
<body>
<div id="lockScreen" class="lock-screen">
<div class="lock-icon">üîí</div>
<h2>Secret Chat</h2>
<p style="color:var(--ios-text-secondary);margin-bottom:30px;">Passwort eingeben</p>
<input type="password" id="lockPasscode" class="ios-input" placeholder="Passwort" style="max-width:280px;">
<button onclick="unlockChat()" class="ios-button" style="max-width:280px;">Entsperren</button>
<button onclick="closeLock()" class="ios-button ios-button-secondary" style="max-width:280px;">Abbrechen</button>
</div>

<div class="app">
<div class="sidebar-desktop desktop-only">
<div style="padding:20px;font-size:24px;font-weight:700;">‚è∞ TimeRoster</div>
<div class="sidebar-item active" onclick="navigate('dashboard')">üìä Dashboard</div>
<div class="sidebar-item" onclick="navigate('calendar')">üìÖ Kalender</div>
<div class="sidebar-item" onclick="navigate('shifts')">üë• Schichten</div>
<div class="sidebar-item" onclick="navigate('timetracking')">‚è±Ô∏è Zeiterfassung</div>
<div class="sidebar-item" onclick="navigate('todos')">‚úì Aufgaben</div>
<div class="sidebar-item" onclick="navigate('chat')">üí¨ Secret Chat</div>
<div class="sidebar-item" onclick="navigate('settings')">‚öôÔ∏è Einstellungen</div>
</div>

<div style="flex:1;">
<div class="nav-bar mobile-only">
<div class="nav-title" id="navTitle">Dashboard</div>
</div>

<div class="content">
<div id="dashboard" class="page active">
<div class="stats-grid">
<div class="stat-card"><div class="stat-label">Stunden/Woche</div><div class="stat-value stat-blue" id="weekHours">0.0h</div></div>
<div class="stat-card"><div class="stat-label">Erledigt</div><div class="stat-value stat-green" id="completedTasks">0</div></div>
<div class="stat-card"><div class="stat-label">Schichten</div><div class="stat-value stat-orange" id="upcomingShifts">0</div></div>
<div class="stat-card"><div class="stat-label">Offen</div><div class="stat-value stat-red" id="pendingTodos">0</div></div>
</div>
<div class="ios-card">
<div class="card-header"><div class="card-title">Heutige Termine</div></div>
<div class="card-body" id="todayEvents"><p style="color:var(--ios-text-secondary);">Keine Termine</p></div>
</div>
</div>

<div id="calendar" class="page">
<div class="ios-card">
<div class="card-header"><div class="card-title" id="calendarMonth">Dezember 2025</div></div>
<div class="card-body">
<div style="display:flex;justify-content:space-around;margin-bottom:12px;">
<button onclick="prevMonth()" class="ios-button ios-button-secondary" style="width:auto;padding:8px 16px;margin:0;">‚Äπ</button>
<button onclick="nextMonth()" class="ios-button ios-button-secondary" style="width:auto;padding:8px 16px;margin:0;">‚Ä∫</button>
</div>
<div class="calendar-grid" id="calendarGrid"></div>
</div>
</div>
<button onclick="openEventModal()" class="ios-button">+ Neuer Termin</button>
<div class="ios-list" id="eventsList"></div>
</div>

<div id="shifts" class="page">
<button onclick="openShiftModal()" class="ios-button">+ Neue Schicht</button>
<div class="ios-list" id="shiftsList"></div>
</div>

<div id="timetracking" class="page">
<div class="ios-card">
<div class="time-display">
<div class="current-time" id="currentTime">00:00:00</div>
<div style="margin-bottom:20px;color:var(--ios-text-secondary);" id="statusText">Nicht gestempelt</div>
<button id="clockBtn" onclick="toggleClock()" class="ios-button">Einstempeln</button>
</div>
</div>
<div class="ios-card">
<div class="card-header"><div class="card-title">Protokoll</div></div>
<div id="timeLog"></div>
</div>
</div>

<div id="todos" class="page">
<div class="ios-card" style="margin-bottom:16px;">
<div class="card-body">
<input type="text" id="todoInput" class="ios-input" placeholder="Neue Aufgabe..." style="margin:0;">
</div>
</div>
<div class="ios-card"><div id="todoList"></div></div>
</div>

<div id="chat" class="page">
<div class="ios-card">
<div class="card-header">
<div class="card-title">üí¨ Secret Chat</div>
<button onclick="clearChat()" style="background:var(--ios-red);color:white;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;">L√∂schen</button>
</div>
<div class="card-body">
<div class="chat-messages" id="chatMessages"></div>
<div style="display:flex;gap:8px;margin-bottom:12px;">
<button onclick="document.getElementById('imageInput').click()" class="ios-button ios-button-secondary" style="width:auto;padding:10px 16px;margin:0;">üì∑ Bild</button>
<button onclick="startVoiceRecording()" id="voiceBtn" class="ios-button ios-button-secondary" style="width:auto;padding:10px 16px;margin:0;">üé§ Sprache</button>
<input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="sendImage(event)">
</div>
<div class="chat-input-container">
<input type="text" id="chatInput" class="chat-input" placeholder="Nachricht...">
<button onclick="sendMessage()" class="chat-send-btn">‚û§</button>
</div>
</div>
</div>
<div class="ios-card">
<div class="card-body">
<p style="font-size:13px;color:var(--ios-text-secondary);text-align:center;">üîí Nachrichten werden lokal verschl√ºsselt</p>
</div>
</div>
</div>

<div id="settings" class="page">
<div class="ios-card">
<div class="card-header"><div class="card-title">Daten</div></div>
<div class="card-body">
<button onclick="exportData()" class="ios-button">üì• Exportieren</button>
<button onclick="document.getElementById('importFile').click()" class="ios-button ios-button-secondary">üì§ Importieren</button>
<input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
</div>
</div>
<div class="ios-card">
<div class="card-header"><div class="card-title">Chat Passwort</div></div>
<div class="card-body">
<input type="password" id="oldPasscode" class="ios-input" placeholder="Altes Passwort">
<input type="password" id="newPasscode" class="ios-input" placeholder="Neues Passwort">
<button onclick="setPasscode()" class="ios-button">√Ñndern</button>
</div>
</div>
<div class="ios-card">
<div class="card-header"><div class="card-title">Verkn√ºpfte Benutzer</div></div>
<div class="card-body">
<input type="text" id="linkUserInput" class="ios-input" placeholder="Benutzer-ID eingeben" style="margin:0;">
<button onclick="linkUser()" class="ios-button">Benutzer verkn√ºpfen</button>
<div id="linkedUsersList" style="margin-top:12px;"></div>
</div>
</div>
<div class="ios-card">
<div class="card-header"><div class="card-title">Speicher</div></div>
<div class="ios-list">
<div class="ios-list-item">Termine: <span id="eventsCount">0</span></div>
<div class="ios-list-item">Schichten: <span id="shiftsCount">0</span></div>
<div class="ios-list-item">Aufgaben: <span id="todosCount">0</span></div>
<div class="ios-list-item">Nachrichten: <span id="messagesCount">0</span></div>
</div>
</div>
<button onclick="clearAllData()" class="ios-button ios-button-danger">üóëÔ∏è Alle Daten l√∂schen</button>
</div>
</div>

<div class="tab-bar mobile-only">
<div class="tab-item active" onclick="navigate('dashboard')"><div class="tab-icon">üìä</div><div class="tab-label">Home</div></div>
<div class="tab-item" onclick="navigate('calendar')"><div class="tab-icon">üìÖ</div><div class="tab-label">Kalender</div></div>
<div class="tab-item" onclick="navigate('todos')"><div class="tab-icon">‚úì</div><div class="tab-label">Aufgaben</div></div>
<div class="tab-item" onclick="navigate('chat')"><div class="tab-icon">üí¨</div><div class="tab-label">Chat</div></div>
<div class="tab-item" onclick="navigate('settings')"><div class="tab-icon">‚öôÔ∏è</div><div class="tab-label">Mehr</div></div>
</div>
</div>
</div>

<div id="eventModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div style="font-weight:600;">Neuer Termin</div>
<button onclick="closeModal('eventModal')" style="background:none;border:none;color:var(--ios-blue);cursor:pointer;">Abbrechen</button>
</div>
<div class="modal-body">
<input type="text" id="eventTitle" class="ios-input" placeholder="Titel">
<input type="date" id="eventDate" class="ios-input">
<input type="time" id="eventTime" class="ios-input">
<button onclick="saveEvent()" class="ios-button">Speichern</button>
</div>
</div>
</div>

<div id="shiftModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div style="font-weight:600;">Neue Schicht</div>
<button onclick="closeModal('shiftModal')" style="background:none;border:none;color:var(--ios-blue);cursor:pointer;">Abbrechen</button>
</div>
<div class="modal-body">
<input type="date" id="shiftDate" class="ios-input">
<input type="time" id="shiftStart" class="ios-input" placeholder="Beginn">
<input type="time" id="shiftEnd" class="ios-input" placeholder="Ende">
<button onclick="saveShift()" class="ios-button">Speichern</button>
</div>
</div>
</div>

<script>
class DataStore{constructor(){this.events=this.load('events')||[];this.shifts=this.load('shifts')||[];this.todos=this.load('todos')||[];this.timeEntries=this.load('timeEntries')||[];this.currentSession=this.load('currentSession')||null;this.messages=this.load('messages')||[];this.passcode=this.load('passcode')||'1234';this.linkedUsers=this.load('linkedUsers')||[];this.currentUser=this.load('currentUser')||'user_'+Date.now();}load(key){const data=localStorage.getItem(key);return data?JSON.parse(data):null;}save(key,data){localStorage.setItem(key,JSON.stringify(data));}addEvent(event){event.id=Date.now();this.events.push(event);this.save('events',this.events);}addShift(shift){shift.id=Date.now();this.shifts.push(shift);this.save('shifts',this.shifts);}addTodo(todo){todo.id=Date.now();todo.completed=false;this.todos.push(todo);this.save('todos',this.todos);}toggleTodo(id){const todo=this.todos.find(t=>t.id===id);if(todo){todo.completed=!todo.completed;this.save('todos',this.todos);}}deleteTodo(id){this.todos=this.todos.filter(t=>t.id!==id);this.save('todos',this.todos);}clockIn(){this.currentSession={startTime:new Date().toISOString(),date:new Date().toISOString().split('T')[0]};this.save('currentSession',this.currentSession);}clockOut(){if(this.currentSession){const entry={id:Date.now(),date:this.currentSession.date,startTime:this.currentSession.startTime,endTime:new Date().toISOString()};this.timeEntries.push(entry);this.save('timeEntries',this.timeEntries);this.currentSession=null;this.save('currentSession',null);}}addMessage(text,type='text',data=null){const message={id:Date.now(),text:text,time:new Date().toISOString(),type:'sent',messageType:type,data:data,from:this.currentUser};this.messages.push(message);this.save('messages',this.messages);}clearMessages(){this.messages=[];this.save('messages',this.messages);}setPasscode(oldCode,newCode){if(oldCode===this.passcode){this.passcode=newCode;this.save('passcode',newCode);return true;}return false;}linkUser(userId){if(!this.linkedUsers.includes(userId)){this.linkedUsers.push(userId);this.save('linkedUsers',this.linkedUsers);return true;}return false;}unlinkUser(userId){this.linkedUsers=this.linkedUsers.filter(u=>u!==userId);this.save('linkedUsers',this.linkedUsers);}exportData(){return{events:this.events,shifts:this.shifts,todos:this.todos,timeEntries:this.timeEntries,messages:this.messages};}importData(data){if(data.events){this.events=data.events;this.save('events',this.events);}if(data.shifts){this.shifts=data.shifts;this.save('shifts',this.shifts);}if(data.todos){this.todos=data.todos;this.save('todos',this.todos);}if(data.timeEntries){this.timeEntries=data.timeEntries;this.save('timeEntries',this.timeEntries);}if(data.messages){this.messages=data.messages;this.save('messages',this.messages);}}clearAll(){this.events=[];this.shifts=[];this.todos=[];this.timeEntries=[];this.currentSession=null;this.messages=[];localStorage.clear();this.passcode='1234';this.save('passcode','1234');}}

const store=new DataStore();let currentMonth=new Date();let chatUnlocked=false;

function navigate(pageName){if(pageName==='chat'&&!chatUnlocked){showLockScreen();return;}document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(pageName).classList.add('active');document.querySelectorAll('.tab-item,.sidebar-item').forEach(t=>t.classList.remove('active'));document.querySelectorAll(`[onclick="navigate('${pageName}')"]`).forEach(t=>t.classList.add('active'));const titles={dashboard:'Dashboard',calendar:'Kalender',shifts:'Schichten',timetracking:'Zeiterfassung',todos:'Aufgaben',chat:'Secret Chat',settings:'Einstellungen'};document.getElementById('navTitle').textContent=titles[pageName]||pageName;refreshPage(pageName);}

function showLockScreen(){document.getElementById('lockScreen').classList.add('active');}
function closeLock(){document.getElementById('lockScreen').classList.remove('active');}
function unlockChat(){const input=document.getElementById('lockPasscode').value;if(input===store.passcode){chatUnlocked=true;closeLock();navigate('chat');}else{alert('Falsches Passwort!');document.getElementById('lockPasscode').value='';}}

function refreshPage(pageName){switch(pageName){case 'dashboard':updateDashboard();break;case 'calendar':renderCalendar();renderEvents();break;case 'shifts':renderShifts();break;case 'timetracking':renderTimeLog();updateClockStatus();break;case 'todos':renderTodos();break;case 'chat':renderChat();break;case 'settings':updateStorageInfo();break;}}

function updateDashboard(){const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());let weekHours=0;store.timeEntries.forEach(entry=>{const entryDate=new Date(entry.date);if(entryDate>=weekStart){const start=new Date(entry.startTime);const end=new Date(entry.endTime);weekHours+=(end-start)/(1000*60*60);}});document.getElementById('weekHours').textContent=weekHours.toFixed(1)+'h';document.getElementById('completedTasks').textContent=store.todos.filter(t=>t.completed).length;document.getElementById('upcomingShifts').textContent=store.shifts.filter(s=>new Date(s.date)>=now).length;document.getElementById('pendingTodos').textContent=store.todos.filter(t=>!t.completed).length;const today=now.toISOString().split('T')[0];const todayEvents=store.events.filter(e=>e.date===today);const todayEventsDiv=document.getElementById('todayEvents');if(todayEvents.length===0){todayEventsDiv.innerHTML='<p style="color:var(--ios-text-secondary);">Keine Termine</p>';}else{todayEventsDiv.innerHTML=todayEvents.map(event=>`<div style="padding:8px 0;border-bottom:0.5px solid var(--ios-separator);"><div style="font-weight:600;">${event.title}</div><div style="font-size:15px;color:var(--ios-text-secondary);">${event.time||'Ganzt√§gig'}</div></div>`).join('');}}

function renderCalendar(){const year=currentMonth.getFullYear();const month=currentMonth.getMonth();const monthNames=['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];document.getElementById('calendarMonth').textContent=`${monthNames[month]} ${year}`;const firstDay=new Date(year,month,1).getDay();const daysInMonth=new Date(year,month+1,0).getDate();let html='';const dayHeaders=['So','Mo','Di','Mi','Do','Fr','Sa'];dayHeaders.forEach(day=>{html+=`<div style="text-align:center;font-size:13px;color:var(--ios-text-secondary);font-weight:600;">${day}</div>`;});for(let i=0;i<firstDay;i++){html+='<div></div>';}const today=new Date();for(let day=1;day<=daysInMonth;day++){const date=new Date(year,month,day);const dateStr=date.toISOString().split('T')[0];const hasEvents=store.events.some(e=>e.date===dateStr);const isToday=date.toDateString()===today.toDateString();let classes='calendar-day';if(isToday)classes+=' today';html+=`<div class="${classes}" onclick="selectDate('${dateStr}')">${day}</div>`;}document.getElementById('calendarGrid').innerHTML=html;}

function prevMonth(){currentMonth.setMonth(currentMonth.getMonth()-1);renderCalendar();}
function nextMonth(){currentMonth.setMonth(currentMonth.getMonth()+1);renderCalendar();}
function selectDate(date){document.getElementById('eventDate').value=date;openEventModal();}

function renderEvents(){const eventsDiv=document.getElementById('eventsList');if(store.events.length===0){eventsDiv.innerHTML='<div class="ios-list-item"><p style="color:var(--ios-text-secondary);">Keine Termine</p></div>';return;}const sorted=[...store.events].sort((a,b)=>new Date(a.date)-new Date(b.date));eventsDiv.innerHTML=sorted.map(event=>{const date=new Date(event.date);const formattedDate=date.toLocaleDateString('de-DE',{weekday:'short',day:'numeric',month:'short'});return`<div class="ios-list-item"><div>${event.title}</div><div style="font-size:15px;color:var(--ios-text-secondary);">${formattedDate} ${event.time?'‚Ä¢ '+event.time:''}</div></div>`;}).join('');}

function renderShifts(){const shiftsDiv=document.getElementById('shiftsList');if(store.shifts.length===0){shiftsDiv.innerHTML='<div class="ios-list-item"><p style="color:var(--ios-text-secondary);">Keine Schichten</p></div>';return;}const sorted=[...store.shifts].sort((a,b)=>new Date(a.date)-new Date(b.date));shiftsDiv.innerHTML=sorted.map(shift=>{const date=new Date(shift.date);const formattedDate=date.toLocaleDateString('de-DE',{weekday:'short',day:'numeric',month:'short'});return`<div class="ios-list-item"><div>Schicht</div><div style="font-size:15px;color:var(--ios-text-secondary);">${formattedDate} ‚Ä¢ ${shift.startTime} - ${shift.endTime}</div></div>`;}).join('');}

function updateClock(){const now=new Date();const timeStr=now.toLocaleTimeString('de-DE');document.getElementById('currentTime').textContent=timeStr;}
setInterval(updateClock,1000);updateClock();

function updateClockStatus(){const btn=document.getElementById('clockBtn');const statusText=document.getElementById('statusText');if(store.currentSession){btn.textContent='Ausstempeln';btn.className='ios-button ios-button-danger';statusText.textContent='Eingestempelt';}else{btn.textContent='Einstempeln';btn.className='ios-button';statusText.textContent='Nicht gestempelt';}}

function toggleClock(){if(store.currentSession){store.clockOut();}else{store.clockIn();}updateClockStatus();renderTimeLog();updateDashboard();}

function renderTimeLog(){const logDiv=document.getElementById('timeLog');if(store.timeEntries.length===0){logDiv.innerHTML='<div class="ios-list-item"><p style="color:var(--ios-text-secondary);">Keine Eintr√§ge</p></div>';return;}const sorted=[...store.timeEntries].sort((a,b)=>new Date(b.date)-new Date(a.date));logDiv.innerHTML=sorted.map(entry=>{const start=new Date(entry.startTime);const end=new Date(entry.endTime);const duration=((end-start)/(1000*60*60)).toFixed(2);const date=new Date(entry.date);const formattedDate=date.toLocaleDateString('de-DE',{weekday:'short',day:'numeric',month:'short'});return`<div class="ios-list-item"><div><div>${formattedDate}</div><div style="font-size:13px;color:var(--ios-text-secondary);">${start.toLocaleTimeString('de-DE')} - ${end.toLocaleTimeString('de-DE')}</div></div><div style="font-weight:600;color:var(--ios-blue);">${duration}h</div></div>`;}).join('');}

function renderTodos(){const todoList=document.getElementById('todoList');if(store.todos.length===0){todoList.innerHTML='<div class="ios-list-item"><p style="color:var(--ios-text-secondary);">Keine Aufgaben</p></div>';return;}const sorted=[...store.todos].sort((a,b)=>{if(a.completed!==b.completed)return a.completed?1:-1;return 0;});todoList.innerHTML=sorted.map(todo=>`<div class="todo-item"><div class="todo-checkbox ${todo.completed?'checked':''}" onclick="toggleTodo(${todo.id})"></div><div style="flex:1;${todo.completed?'text-decoration:line-through;color:var(--ios-text-secondary);':''}">${todo.text}</div></div>`).join('');}

function toggleTodo(id){store.toggleTodo(id);renderTodos();updateDashboard();}

document.getElementById('todoInput')?.addEventListener('keypress',function(e){if(e.key==='Enter'&&this.value.trim()){store.addTodo({text:this.value.trim(),priority:'medium'});this.value='';renderTodos();updateDashboard();}});

function renderChat(){const chatDiv=document.getElementById('chatMessages');if(store.messages.length===0){chatDiv.innerHTML='<p style="color:var(--ios-text-secondary);text-align:center;padding:20px;">Keine Nachrichten</p>';return;}chatDiv.innerHTML=store.messages.map(msg=>{const time=new Date(msg.time).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});let content='';if(msg.messageType==='image'){content=`<img src="${msg.data}" class="message-image" onclick="window.open('${msg.data}','_blank')" alt="Bild">`;}else if(msg.messageType==='voice'){content=`<div class="message-voice"><button class="voice-play-btn" onclick="playVoice('${msg.data}')">‚ñ∂</button><span>Sprachnachricht</span></div>`;}else{content=msg.text;}return`<div class="chat-message ${msg.type}"><div class="message-bubble">${content}<div style="font-size:11px;margin-top:4px;">${time}</div></div></div>`;}).join('');chatDiv.scrollTop=chatDiv.scrollHeight;}

function sendMessage(){const input=document.getElementById('chatInput');if(input.value.trim()){store.addMessage(input.value.trim(),'text',null);input.value='';renderChat();updateStorageInfo();}}

function sendImage(event){const file=event.target.files[0];if(file&&file.type.startsWith('image/')){const reader=new FileReader();reader.onload=(e)=>{const base64=e.target.result;store.addMessage('Bild gesendet','image',base64);renderChat();updateStorageInfo();};reader.readAsDataURL(file);}}

let mediaRecorder=null;let audioChunks=[];function startVoiceRecording(){const btn=document.getElementById('voiceBtn');if(mediaRecorder&&mediaRecorder.state==='recording'){mediaRecorder.stop();btn.textContent='üé§ Sprache';return;}navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{mediaRecorder=new MediaRecorder(stream);audioChunks=[];mediaRecorder.ondataavailable=e=>{audioChunks.push(e.data);};mediaRecorder.onstop=()=>{const audioBlob=new Blob(audioChunks,{type:'audio/webm'});const reader=new FileReader();reader.onload=()=>{const base64=reader.result;store.addMessage('Sprachnachricht','voice',base64);renderChat();updateStorageInfo();stream.getTracks().forEach(track=>track.stop());};reader.readAsDataURL(audioBlob);};mediaRecorder.start();btn.textContent='‚èπÔ∏è Stop';}).catch(err=>{alert('Mikrofon-Zugriff verweigert!');});}

function playVoice(base64){const audio=new Audio(base64);audio.play();}

function linkUser(){const input=document.getElementById('linkUserInput');if(input.value.trim()){if(store.linkUser(input.value.trim())){input.value='';renderLinkedUsers();alert('Benutzer verkn√ºpft!');}else{alert('Benutzer bereits verkn√ºpft!');}}}

function unlinkUser(userId){if(confirm('Benutzer entfernen?')){store.unlinkUser(userId);renderLinkedUsers();}}

function renderLinkedUsers(){const listDiv=document.getElementById('linkedUsersList');if(store.linkedUsers.length===0){listDiv.innerHTML='<p style="color:var(--ios-text-secondary);font-size:13px;">Keine verkn√ºpften Benutzer</p>';return;}listDiv.innerHTML=store.linkedUsers.map(user=>`<div class="linked-user-item"><span>${user}</span><button onclick="unlinkUser('${user}')" style="background:var(--ios-red);color:white;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px;">Entfernen</button></div>`).join('');}

document.getElementById('chatInput')?.addEventListener('keypress',function(e){if(e.key==='Enter'){sendMessage();}});

function clearChat(){if(confirm('Alle Nachrichten l√∂schen?')){store.clearMessages();renderChat();updateStorageInfo();}}

function updateStorageInfo(){document.getElementById('eventsCount').textContent=store.events.length;document.getElementById('shiftsCount').textContent=store.shifts.length;document.getElementById('todosCount').textContent=store.todos.length;document.getElementById('messagesCount').textContent=store.messages.length;renderLinkedUsers();}

function setPasscode(){const oldCode=document.getElementById('oldPasscode').value;const newCode=document.getElementById('newPasscode').value;if(!oldCode||!newCode){alert('Bitte beide Felder ausf√ºllen!');return;}if(newCode.length<4){alert('Neues Passwort muss mindestens 4 Zeichen haben!');return;}if(store.setPasscode(oldCode,newCode)){alert('Passwort erfolgreich ge√§ndert!');document.getElementById('oldPasscode').value='';document.getElementById('newPasscode').value='';}else{alert('Altes Passwort ist falsch!');}}

function exportData(){const data=store.exportData();const json=JSON.stringify(data,null,2);const blob=new Blob([json],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`timeroster-backup-${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(url);}

function importData(event){const file=event.target.files[0];if(file){const reader=new FileReader();reader.onload=(e)=>{try{const data=JSON.parse(e.target.result);if(confirm('Aktuelle Daten ersetzen?')){store.importData(data);alert('Daten importiert!');refreshPage('settings');}}catch(err){alert('Fehler beim Importieren!');}};reader.readAsText(file);}}

function clearAllData(){if(confirm('Wirklich alle Daten l√∂schen?')){if(confirm('Letzte Best√§tigung!')){store.clearAll();alert('Alle Daten gel√∂scht.');location.reload();}}}

function openEventModal(){document.getElementById('eventModal').classList.add('active');if(!document.getElementById('eventDate').value){document.getElementById('eventDate').value=new Date().toISOString().split('T')[0];}}

function openShiftModal(){document.getElementById('shiftModal').classList.add('active');document.getElementById('shiftDate').value=new Date().toISOString().split('T')[0];}

function closeModal(modalId){document.getElementById(modalId).classList.remove('active');}

function saveEvent(){const event={title:document.getElementById('eventTitle').value,date:document.getElementById('eventDate').value,time:document.getElementById('eventTime').value};if(event.title&&event.date){store.addEvent(event);closeModal('eventModal');renderCalendar();renderEvents();updateDashboard();document.getElementById('eventTitle').value='';document.getElementById('eventTime').value='';}}

function saveShift(){const shift={date:document.getElementById('shiftDate').value,startTime:document.getElementById('shiftStart').value,endTime:document.getElementById('shiftEnd').value};if(shift.date&&shift.startTime&&shift.endTime){store.addShift(shift);closeModal('shiftModal');renderShifts();updateDashboard();document.getElementById('shiftStart').value='';document.getElementById('shiftEnd').value='';}}

document.querySelectorAll('.modal').forEach(modal=>{modal.addEventListener('click',function(e){if(e.target===this){this.classList.remove('active');}});});

updateDashboard();renderCalendar();
</script>
</body>
</html>
